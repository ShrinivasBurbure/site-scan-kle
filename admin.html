<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SiteScan Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b, #111827);
    --card-bg: rgba(255, 255, 255, 0.08);
    --accent: #3b82f6;
    --accent-glow: #60a5fa;
    --text-dark: #f1f5f9;
    --text-muted: #94a3b8;
    --radius: 16px;
    --shadow-glow: 0 0 20px rgba(59,130,246,0.4);
    --shadow-soft: 0 10px 30px rgba(0,0,0,0.2);
    --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --electricity: #f59e0b;
    --water: #3b82f6;
    --roads: #10b981;
    --sanitation: #8b5cf6;
    --others: #64748b;
    --total: #ec4899;
  }

  :root[data-theme="light"] {
    --bg-gradient: linear-gradient(135deg, #e0f2fe, #f0f9ff, #dbeafe);
    --card-bg: rgba(255, 255, 255, 0.9);
    --accent: #2563eb;
    --accent-glow: #3b82f6;
    --text-dark: #1e293b;
    --text-muted: #64748b;
    --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.3);
    --shadow-soft: 0 10px 30px rgba(0,0,0,0.1);
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
    --electricity: #d97706;
    --water: #2563eb;
    --roads: #059669;
    --sanitation: #7c3aed;
    --others: #475569;
    --total: #db2777;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    background: var(--bg-gradient);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    min-height: 100vh;
    font-weight: 500;
    transition: background 0.5s ease, color 0.5s ease;
  }

  /* Header */
  header {
    background: var(--card-bg);
    padding: 16px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    box-shadow: var(--shadow-soft);
    position: sticky;
    top: 0;
    z-index: 100;
    animation: slideDown 0.8s ease-out;
    transition: background 0.5s ease, border-color 0.5s ease;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    font-size: 2rem;
    color: var(--accent);
    text-shadow: var(--shadow-glow);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .logo h1 {
    font-size: 1.8rem;
    font-weight: 800;
    background: linear-gradient(90deg, var(--accent), var(--accent-glow));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
  }

  .header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .theme-toggle {
    background: var(--card-bg);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 50px;
    padding: 10px 15px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dark);
    font-weight: 600;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-soft);
  }

  .theme-toggle:hover {
    transform: translateY(-2px) rotate(5deg);
    box-shadow: var(--shadow-glow);
  }

  .back-to-home {
    background: var(--card-bg);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 50px;
    padding: 10px 20px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dark);
    font-weight: 600;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-soft);
    text-decoration: none;
  }

  .back-to-home:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow);
  }

  /* Main Container */
  .main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 30px;
  }

  /* Stats Overview */
  .stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,0,0,0.1);
    transition: var(--transition);
    animation: fadeInUp 0.6s ease-out;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent);
  }

  .stat-card:nth-child(1)::before { background: var(--electricity); }
  .stat-card:nth-child(2)::before { background: var(--water); }
  .stat-card:nth-child(3)::before { background: var(--roads); }
  .stat-card:nth-child(4)::before { background: var(--sanitation); }
  .stat-card:nth-child(5)::before { background: var(--others); }
  .stat-card:nth-child(6)::before { background: var(--total); }

  .stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-glow);
  }

  .stat-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
    color: var(--accent);
    transition: var(--transition);
  }

  .stat-card:hover .stat-icon {
    transform: scale(1.2) rotate(10deg);
  }

  .stat-number {
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--accent-glow);
    margin-bottom: 5px;
    text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
  }

  .stat-label {
    color: var(--text-dark);
    font-size: 0.95rem;
    font-weight: 600;
  }

  /* Filters Section */
  .filters-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 30px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,0,0,0.1);
    animation: fadeInUp 0.8s ease-out;
    transition: background 0.5s ease, border-color 0.5s ease;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-glow);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-label {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.95rem;
  }

  .filter-select, .filter-input {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.2);
    background: var(--card-bg);
    color: var(--text-dark);
    font-size: 0.95rem;
    transition: var(--transition);
    font-weight: 500;
  }

  .filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    transform: translateY(-2px);
  }

  .filter-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    border: none;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: var(--shadow-glow);
  }

  .btn-primary:hover {
    background: var(--accent-glow);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
  }

  .btn-secondary {
    background: rgba(0,0,0,0.05);
    color: var(--text-dark);
    border: 1px solid rgba(0,0,0,0.1);
  }

  .btn-secondary:hover {
    background: rgba(0,0,0,0.1);
    border-color: var(--accent);
    transform: translateY(-3px);
  }

  /* Chart Section */
  .chart-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 30px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(156, 17, 17, 0.1);
    animation: fadeInUp 1s ease-out;
    transition: background 0.5s ease, border-color 0.5s ease;
  }

  .chart-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .chart-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0,0,0,0.05);
    color: var(--text-dark);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .chart-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
    transform: scale(1.05);
  }

  .chart-btn:hover:not(.active) {
    border-color: var(--accent);
    transform: translateY(-2px);
  }

  .chart-wrapper {
    height: 300px;
    width: 100%;
    position: relative;
  }

  /* Table Section */
  .table-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,0,0,0.1);
    animation: fadeInUp 1.2s ease-out;
    overflow: hidden;
    transition: background 0.5s ease, border-color 0.5s ease;
  }

  .table-container {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
  }

  th {
    background: var(--accent);
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    position: sticky;
    top: 0;
  }

  td {
    padding: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    font-size: 0.85rem;
    vertical-align: middle;
    font-weight: 500;
  }

  tr {
    transition: var(--transition);
  }

  tr:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: scale(1.01);
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    transition: var(--transition);
  }

  .status-badge:hover {
    transform: scale(1.05);
  }

  .status-pending {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .status-in-progress {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.2);
  }

  .status-Solved {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .media-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: var(--transition);
  }

  .media-link:hover {
    color: var(--accent-glow);
    transform: translateY(-2px) scale(1.05);
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes bounceIn {
    0% {
      transform: scale(0.3);
      opacity: 0;
    }
    50% {
      transform: scale(1.05);
    }
    70% {
      transform: scale(0.9);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes glow {
    0% {
      box-shadow: 0 0 5px var(--accent);
    }
    50% {
      box-shadow: 0 0 20px var(--accent);
    }
    100% {
      box-shadow: 0 0 5px var(--accent);
    }
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes zoomIn {
    from {
      opacity: 0;
      transform: scale(0.5);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main-container {
      padding: 15px;
    }
    
    .filters-grid {
      grid-template-columns: 1fr;
    }
    
    .filter-actions {
      justify-content: stretch;
    }
    
    .btn {
      flex: 1;
      justify-content: center;
    }
    
    header {
      padding: 12px 15px;
      flex-direction: column;
      gap: 15px;
    }
    
    .header-actions {
      width: 100%;
      justify-content: space-between;
    }
  }

  /* Loading Animation */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    flex-direction: column;
    gap: 15px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(59, 130, 246, 0.2);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dark);
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.7;
    animation: bounce 2s infinite;
  }

  @keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
      transform: translateY(0);
    }
    40%, 43% {
      transform: translateY(-15px);
    }
    70% {
      transform: translateY(-7px);
    }
    90% {
      transform: translateY(-3px);
    }
  }

  /* Department Colors */
  .dept-electricity { color: var(--electricity); }
  .dept-water { color: var(--water); }
  .dept-roads { color: var(--roads); }
  .dept-sanitation { color: var(--sanitation); }
  .dept-others { color: var(--others); }
  .dept-total { color: var(--total); }

  /* Floating animation for cards */
  @keyframes float {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
    100% {
      transform: translateY(0px);
    }
  }

  .floating {
    animation: float 5s ease-in-out infinite;
  }

  /* Shimmer effect for loading */
  .shimmer {
    background: linear-gradient(90deg, 
      rgba(255,255,255,0) 0%, 
      rgba(255,255,255,0.1) 50%, 
      rgba(255,255,255,0) 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  /* Notification badge */
  .notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    animation: pulse 1.5s infinite;
  }

  /* Theme transition */
  .theme-transition {
    transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon">üìä</div>
    <h1>SiteScan Admin Dashboard</h1>
  </div>
  <div class="header-actions">
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
      <span>Dark Mode</span>
    </button>
    <a href="index.html" class="back-to-home">
      <i class="fas fa-home"></i>
      <span>Back to Home</span>
    </a>
  </div>
</header>

<div class="main-container">
  <!-- Stats Overview -->
  <div class="stats-overview">
    <div class="stat-card floating">
      <div class="stat-icon"><i class="fas fa-bolt dept-electricity"></i></div>
      <div class="stat-number" id="electricityComplaints">0</div>
      <div class="stat-label">Electricity Issues</div>
    </div>
    <div class="stat-card floating" style="animation-delay: 0.2s;">
      <div class="stat-icon"><i class="fas fa-tint dept-water"></i></div>
      <div class="stat-number" id="waterComplaints">0</div>
      <div class="stat-label">Water Issues</div>
    </div>
    <div class="stat-card floating" style="animation-delay: 0.4s;">
      <div class="stat-icon"><i class="fas fa-road dept-roads"></i></div>
      <div class="stat-number" id="roadsComplaints">0</div>
      <div class="stat-label">Roads & Infrastructure</div>
    </div>
    <div class="stat-card floating" style="animation-delay: 0.6s;">
      <div class="stat-icon"><i class="fas fa-trash dept-sanitation"></i></div>
      <div class="stat-number" id="sanitationComplaints">0</div>
      <div class="stat-label">Sanitation Issues</div>
    </div>
    <div class="stat-card floating" style="animation-delay: 0.8s;">
      <div class="stat-icon"><i class="fas fa-cogs dept-others"></i></div>
      <div class="stat-number" id="othersComplaints">0</div>
      <div class="stat-label">Other Issues</div>
    </div>
    <div class="stat-card floating" style="animation-delay: 1s;">
      <div class="stat-icon"><i class="fas fa-chart-bar dept-total"></i></div>
      <div class="stat-number" id="totalComplaints">0</div>
      <div class="stat-label">Total Complaints</div>
    </div>
  </div>

  <!-- Enhanced Filters -->
  <div class="filters-section">
    <div class="section-title">
      <i class="fas fa-filter"></i>
      <span>Filter Complaints</span>
    </div>
    
    <div class="filters-grid">
      <div class="filter-group">
        <label class="filter-label">Department</label>
        <select class="filter-select" id="filterDept">
          <option value="">All Departments</option>
          <option value="Electricity">Electricity</option>
          <option value="Water">Water</option>
          <option value="Roads & Infrastructure">Roads & Infrastructure</option>
          <option value="Sanitation">Sanitation</option>
          <option value="Others">Other Issues</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select class="filter-select" id="filterStatus">
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Solved">Solved</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Location</label>
        <select class="filter-select" id="filterLocation">
          <option value="">All Locations</option>
          <!-- Locations will be populated dynamically -->
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Date Range</label>
        <input type="date" class="filter-input" id="filterDate">
      </div>
    </div>
    
    <div class="filter-actions">
      <button class="btn btn-secondary" id="resetFilters">
        <i class="fas fa-refresh"></i>
        Reset Filters
      </button>
      <button class="btn btn-primary" id="applyFilters">
        <i class="fas fa-search"></i>
        Apply Filters
      </button>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="chart-section">
    <div class="section-title">
      <i class="fas fa-chart-bar"></i>
      <span>Complaints Analytics</span>
    </div>
    
    <div class="chart-controls">
      <button class="chart-btn" id="dayBtn">Daily</button>
      <button class="chart-btn" id="weekBtn">Weekly</button>
      <button class="chart-btn" id="monthBtn">Monthly</button>
      <button class="chart-btn active" id="deptBtn">By Department</button>
    </div>
    
    <div class="chart-wrapper">
      <canvas id="complaintsChart"></canvas>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-section">
    <div class="section-title">
      <i class="fas fa-list"></i>
      <span>All Complaints</span>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Department</th>
            <th>Issue</th>
            <th>Location</th>
            <th>Date</th>
            <th>Status</th>
            <th>Media</th>
          </tr>
        </thead>
        <tbody id="complaintsBody">
          <tr>
            <td colspan="8" class="loading">
              <div class="spinner"></div>
              <div>Loading complaints...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase configuration
const SUPABASE_URL = "https://wufxlfsavttdijwyxwsv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1ZnhsZnNhdnR0ZGlqd3l4d3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTM1MzcsImV4cCI6MjA3NTc2OTUzN30.NTxr-qXhKJA0CAZ_mX3Q7bE9NbaANtH7AfJ9mI5FvAg";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM Elements
const complaintsBody = document.getElementById('complaintsBody');
const electricityComplaints = document.getElementById('electricityComplaints');
const waterComplaints = document.getElementById('waterComplaints');
const roadsComplaints = document.getElementById('roadsComplaints');
const sanitationComplaints = document.getElementById('sanitationComplaints');
const othersComplaints = document.getElementById('othersComplaints');
const totalComplaints = document.getElementById('totalComplaints');
const themeToggle = document.getElementById('themeToggle');

// Filter Elements
const deptFilter = document.getElementById('filterDept');
const statusFilter = document.getElementById('filterStatus');
const locationFilter = document.getElementById('filterLocation');
const dateFilter = document.getElementById('filterDate');
const resetFiltersBtn = document.getElementById('resetFilters');
const applyFiltersBtn = document.getElementById('applyFilters');

// Chart Elements
const dayBtn = document.getElementById('dayBtn');
const weekBtn = document.getElementById('weekBtn');
const monthBtn = document.getElementById('monthBtn');
const deptBtn = document.getElementById('deptBtn');

let complaintsChart;
let chartView = "dept"; // Default to department view
let allComplaints = [];
let filteredComplaints = [];

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
  // Initialize theme
  initTheme();
  
  // Add event listeners
  themeToggle.addEventListener('click', toggleTheme);
  
  fetchComplaints();
  
  // Add floating animation to stat cards with delays
  document.querySelectorAll('.stat-card').forEach((card, index) => {
    card.style.animationDelay = `${index * 0.2}s`;
  });
});

// Theme functions
function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeToggle(savedTheme);
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  // Add transition class for smooth theme change
  document.body.classList.add('theme-transition');
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeToggle(newTheme);
  
  // Remove transition class after animation completes
  setTimeout(() => {
    document.body.classList.remove('theme-transition');
  }, 500);
}

function updateThemeToggle(theme) {
  const icon = themeToggle.querySelector('i');
  const text = themeToggle.querySelector('span');
  
  if (theme === 'dark') {
    icon.className = 'fas fa-moon';
    text.textContent = 'Dark Mode';
  } else {
    icon.className = 'fas fa-sun';
    text.textContent = 'Light Mode';
  }
  
  // Add animation to the toggle button
  themeToggle.style.animation = 'bounceIn 0.5s';
  setTimeout(() => {
    themeToggle.style.animation = '';
  }, 500);
}

// ----------------- Fetch Complaints from Supabase -----------------
async function fetchComplaints() {
  try {
    complaintsBody.innerHTML = `
      <tr>
        <td colspan="8" class="loading">
          <div class="spinner"></div>
          <div>Loading complaints from database...</div>
        </td>
      </tr>
    `;

    const { data, error } = await supabase
      .from('complaints')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    allComplaints = data || [];
    filteredComplaints = allComplaints;
    
    // Populate location dropdown
    populateLocationFilter();
    
    // Update dashboard
    updateStats();
    renderTable();
    renderChart();
    
    console.log(`‚úÖ Loaded ${allComplaints.length} complaints from database`);
    
  } catch (err) {
    console.error("‚ùå Error fetching complaints:", err);
    complaintsBody.innerHTML = `
      <tr>
        <td colspan="8" style="color: var(--danger); text-align: center; padding: 40px;">
          <i class="fas fa-exclamation-triangle"></i>
          <div>Error loading complaints: ${err.message}</div>
        </td>
      </tr>
    `;
  }
}

// Populate location filter with unique locations from complaints
function populateLocationFilter() {
  // Clear existing options except the first one
  while (locationFilter.options.length > 1) {
    locationFilter.remove(1);
  }
  
  const locations = [...new Set(allComplaints
    .filter(complaint => complaint.location && complaint.location.trim() !== '')
    .map(complaint => complaint.location))];
  
  locations.forEach(location => {
    const option = document.createElement('option');
    option.value = location;
    option.textContent = location;
    locationFilter.appendChild(option);
  });
}

// ----------------- Stats Calculation -----------------
function updateStats() {
  const electricity = allComplaints.filter(c => c.department === "Electricity").length;
  const water = allComplaints.filter(c => c.department === "Water").length;
  const roads = allComplaints.filter(c => c.department === "Roads & Infrastructure").length;
  const sanitation = allComplaints.filter(c => c.department === "Sanitation").length;
  const others = allComplaints.filter(c => c.department === "Others").length;
  const total = allComplaints.length;

  // Animate numbers
  animateValue(electricityComplaints, electricity);
  animateValue(waterComplaints, water);
  animateValue(roadsComplaints, roads);
  animateValue(sanitationComplaints, sanitation);
  animateValue(othersComplaints, others);
  animateValue(totalComplaints, total);
}

function animateValue(element, target) {
  let current = 0;
  const increment = target / 50;
  const timer = setInterval(() => {
    current += increment;
    if (current >= target) {
      element.textContent = target;
      clearInterval(timer);
      
      // Add a subtle animation when counting completes
      element.style.transform = "scale(1.1)";
      setTimeout(() => {
        element.style.transform = "scale(1)";
      }, 300);
    } else {
      element.textContent = Math.floor(current);
    }
  }, 20);
}

// ----------------- Render Table -----------------
function renderTable() {
  if (!filteredComplaints.length) {
    complaintsBody.innerHTML = `
      <tr>
        <td colspan="8" class="empty-state">
          <i class="fas fa-inbox"></i>
          <div>No complaints found matching your filters</div>
        </td>
      </tr>
    `;
    return;
  }

  complaintsBody.innerHTML = filteredComplaints.map((c, index) => `
    <tr class="animate__animated animate__fadeInUp" style="animation-delay: ${index * 0.05}s">
      <td>${c.id}</td>
      <td>${c.name || 'Anonymous'}</td>
      <td><span class="dept-${getDepartmentClass(c.department)}">${c.department || 'General'}</span></td>
      <td title="${c.details || 'No details'}">${c.issue_title || 'No title'}</td>
      <td>${c.location || 'Not specified'}</td>
      <td>${formatDate(c.created_at)}</td>
      <td>
        <div class="status-badge status-${getStatusClass(c.status)}">
          <i class="fas ${getStatusIcon(c.status)}"></i>
          ${c.status || 'Pending'}
        </div>
      </td>
      <td>
        ${c.photo ? `<a href="${c.photo}" class="media-link" target="_blank"><i class="fas fa-image"></i> Photo</a>` : ''}
        ${c.video ? `<a href="${c.video}" class="media-link" target="_blank"><i class="fas fa-video"></i> Video</a>` : ''}
        ${!c.photo && !c.video ? 'No media' : ''}
      </td>
    </tr>
  `).join('');
}

function getDepartmentClass(department) {
  if (!department) return 'others';
  return department.toLowerCase().replace(' & ', '-').replace(' ', '-');
}

function getStatusClass(status) {
  if (!status) return 'pending';
  return status.toLowerCase().replace(' ', '-');
}

function getStatusIcon(status) {
  switch(status) {
    case 'Pending': return 'fa-clock';
    case 'In Progress': return 'fa-tools';
    case 'Solved': return 'fa-check-circle';
    default: return 'fa-question';
  }
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString();
}

// ----------------- Filter Complaints -----------------
function filterComplaints() {
  filteredComplaints = allComplaints;
  
  const deptVal = deptFilter.value;
  const statusVal = statusFilter.value;
  const locationVal = locationFilter.value;
  const dateVal = dateFilter.value;

  if (deptVal) {
    filteredComplaints = filteredComplaints.filter(c => c.department === deptVal);
  }
  
  if (statusVal) {
    // Fixed: Use case-insensitive comparison for status
    filteredComplaints = filteredComplaints.filter(c => 
      c.status && c.status.toLowerCase() === statusVal.toLowerCase()
    );
  }
  
  if (locationVal) {
    filteredComplaints = filteredComplaints.filter(c => c.location === locationVal);
  }
  
  if (dateVal) {
    filteredComplaints = filteredComplaints.filter(c => 
      c.created_at && new Date(c.created_at).toISOString().split('T')[0] === dateVal
    );
  }
  
  renderTable();
}

// ----------------- Chart Functions -----------------
const ctx = document.getElementById('complaintsChart').getContext('2d');

function getChartData() {
  if (chartView === "dept") {
    return getDepartmentChartData();
  }
  
  const grouped = {};
  allComplaints.forEach(c => {
    if (!c.created_at) return;
    const date = new Date(c.created_at);
    let key;
    
    if (chartView === "day") {
      key = date.toLocaleDateString();
    } else if (chartView === "week") {
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay());
      key = `Week ${weekStart.toLocaleDateString()}`;
    } else if (chartView === "month") {
      key = date.toLocaleString('default', { month: 'short', year: 'numeric' });
    }
    
    grouped[key] = (grouped[key] || 0) + 1;
  });
  
  return { 
    labels: Object.keys(grouped), 
    data: Object.values(grouped) 
  };
}

function getDepartmentChartData() {
  const departments = ["Electricity", "Water", "Roads & Infrastructure", "Sanitation", "Others"];
  const data = departments.map(dept => 
    allComplaints.filter(c => c.department === dept).length
  );
  
  return { 
    labels: departments, 
    data 
  };
}

function renderChart() {
  const { labels, data } = getChartData();
  
  if (complaintsChart) {
    complaintsChart.destroy();
  }

  const departmentColors = {
    "Electricity": "rgba(245, 158, 11, 0.7)",
    "Water": "rgba(59, 130, 246, 0.7)",
    "Roads & Infrastructure": "rgba(16, 185, 129, 0.7)",
    "Sanitation": "rgba(139, 92, 246, 0.7)",
    "Others": "rgba(100, 116, 139, 0.7)"
  };

  const backgroundColors = chartView === "dept" 
    ? labels.map(label => departmentColors[label] || "rgba(100, 116, 139, 0.7)")
    : data.map((_, i) => {
        const hue = (i * 137.5) % 360;
        return `hsla(${hue}, 70%, 65%, 0.7)`;
      });

  complaintsChart = new Chart(ctx, {
    type: chartView === "dept" ? 'doughnut' : 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Complaints',
        data,
        backgroundColor: backgroundColors,
        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
        borderWidth: 2,
        borderRadius: chartView === "dept" ? 0 : 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: chartView === "dept",
          position: 'bottom',
          labels: {
            color: 'var(--text-dark)',
            font: {
              size: 12,
              weight: '600'
            }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'var(--card-bg)',
          titleColor: 'var(--text-dark)',
          bodyColor: 'var(--text-dark)',
          titleFont: {
            weight: '600'
          },
          bodyFont: {
            weight: '500'
          }
        }
      },
      scales: chartView === "dept" ? {} : {
        x: {
          grid: {
            display: false,
            color: 'rgba(0,0,0,0.1)'
          },
          ticks: {
            color: 'var(--text-dark)',
            font: {
              weight: '500'
            }
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            color: 'var(--text-dark)',
            font: {
              weight: '500'
            }
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      }
    }
  });
}

// ----------------- Event Listeners -----------------
// Filter events
deptFilter.addEventListener('change', filterComplaints);
statusFilter.addEventListener('change', filterComplaints);
locationFilter.addEventListener('change', filterComplaints);
dateFilter.addEventListener('change', filterComplaints);

applyFiltersBtn.addEventListener('click', filterComplaints);
resetFiltersBtn.addEventListener('click', () => {
  deptFilter.value = '';
  statusFilter.value = '';
  locationFilter.value = '';
  dateFilter.value = '';
  filteredComplaints = allComplaints;
  renderTable();
});

// Chart view buttons
[dayBtn, weekBtn, monthBtn, deptBtn].forEach(btn => {
  btn.addEventListener('click', (e) => {
    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    chartView = e.target.id.replace('Btn', '');
    renderChart();
  });
});

// ----------------- Real-time Updates -----------------
// Subscribe to real-time changes in the complaints table
supabase
  .channel('complaints-changes')
  .on('postgres_changes', 
    { 
      event: '*', 
      schema: 'public', 
      table: 'complaints' 
    }, 
    (payload) => {
      console.log('Change received!', payload);
      // Add a notification effect
      document.querySelector('.logo-icon').style.animation = 'glow 1s';
      setTimeout(() => {
        document.querySelector('.logo-icon').style.animation = 'pulse 2s infinite';
      }, 1000);
      
      fetchComplaints(); // Refresh data when changes occur
    }
  )
  .subscribe();
</script>
</body>
</html>