<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Complaint Hub - Report an Issue</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --success: #4cc9f0;
  --danger: #f72585;
  --warning: #f8961e;
  --light: #f8f9fa;
  --dark: #212529;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --border-radius: 16px;
  --shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  --shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.2);
  --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  padding: 20px;
  overflow-x: hidden;
}

/* Floating Animation */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

/* Pulse Animation */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Bounce Animation */
@keyframes bounce {
  0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
  40%, 43% { transform: translate3d(0,-20px,0); }
  70% { transform: translate3d(0,-10px,0); }
  90% { transform: translate3d(0,-4px,0); }
}

/* Slide In Animation */
@keyframes slideInLeft {
  from { transform: translateX(-50px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInRight {
  from { transform: translateX(50px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Fade In Animation */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Shake Animation */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Ripple Effect */
@keyframes ripple {
  0% { transform: scale(0); opacity: 1; }
  100% { transform: scale(4); opacity: 0; }
}

.container {
  max-width: 800px;
  margin: 0 auto;
  animation: fadeIn 1s ease-out;
}

/* Header */
.hero {
  background: var(--gradient);
  color: white;
  padding: 40px 20px;
  border-radius: var(--border-radius);
  text-align: center;
  margin-bottom: 40px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  animation: slideInUp 0.8s ease-out;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
  background-size: cover;
  animation: pulse 3s ease-in-out infinite;
}

.hero h1 {
  font-size: 2.5rem;
  margin-bottom: 15px;
  position: relative;
  animation: bounce 1s ease-out;
}

.hero h1 i {
  animation: float 3s ease-in-out infinite;
}

.hero p {
  font-size: 1.2rem;
  opacity: 0.9;
  position: relative;
  animation: fadeIn 1s ease-out 0.5s both;
}

/* Progress Bar */
.progress-container {
  margin-bottom: 40px;
  animation: slideInUp 0.8s ease-out 0.2s both;
}

.progress-bar {
  display: flex;
  justify-content: space-between;
  position: relative;
  margin-bottom: 40px;
  counter-reset: step;
}

.progress-bar::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  height: 6px;
  width: 100%;
  background-color: var(--gray-light);
  z-index: 1;
  border-radius: 3px;
}

.progress {
  position: absolute;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  height: 6px;
  background: var(--gradient);
  z-index: 2;
  transition: var(--transition);
  border-radius: 3px;
}

.step {
  width: 50px;
  height: 50px;
  background-color: white;
  border: 4px solid var(--gray-light);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--gray);
  z-index: 3;
  position: relative;
  transition: var(--transition);
  animation: pulse 2s infinite;
}

.step.active {
  border-color: var(--primary);
  color: var(--primary);
  background-color: white;
  animation: bounce 0.6s ease-out;
}

.step.completed {
  background: var(--gradient);
  border-color: var(--primary);
  color: white;
  animation: pulse 1.5s infinite;
}

.step-label {
  position: absolute;
  top: 55px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 0.9rem;
  color: var(--gray);
  font-weight: 500;
}

.step.active .step-label {
  color: var(--primary);
  font-weight: 600;
}

/* Form Container */
.form-container {
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 40px;
  transform: translateY(20px);
  animation: slideInUp 0.8s ease-out 0.4s both;
}

.form-step {
  padding: 40px;
  display: none;
}

.form-step.active {
  display: block;
  animation: fadeIn 0.6s ease-out;
}

.step-header {
  margin-bottom: 35px;
  text-align: center;
  animation: slideInUp 0.6s ease-out;
}

.step-header h2 {
  color: var(--primary);
  margin-bottom: 15px;
  font-size: 1.8rem;
  animation: slideInLeft 0.6s ease-out;
}

.step-header p {
  color: var(--gray);
  font-size: 1.1rem;
  animation: slideInRight 0.6s ease-out;
}

/* Form Elements */
.form-group {
  margin-bottom: 25px;
  animation: slideInUp 0.6s ease-out;
}

.form-group label {
  display: block;
  margin-bottom: 10px;
  font-weight: 600;
  color: var(--dark);
  font-size: 1.1rem;
}

.form-control {
  width: 100%;
  padding: 15px 20px;
  border: 2px solid var(--gray-light);
  border-radius: var(--border-radius);
  font-size: 1rem;
  transition: var(--transition);
  background-color: white;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
  transform: translateY(-2px);
}

.form-control.error {
  border-color: var(--danger);
  animation: shake 0.5s ease-in-out;
}

.error-message {
  color: var(--danger);
  font-size: 0.9rem;
  margin-top: 8px;
  display: none;
  animation: fadeIn 0.3s ease-out;
}

/* Department Selection */
.department-selection {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.department-card {
  background: linear-gradient(135deg, #f0f4ff 0%, #e6eeff 100%);
  border: 3px solid var(--gray-light);
  border-radius: var(--border-radius);
  padding: 25px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  animation: slideInUp 0.6s ease-out;
}

.department-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transition: left 0.5s;
}

.department-card:hover::before {
  left: 100%;
}

.department-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-hover);
}

.department-card.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, #e6eeff 0%, #d0dcff 100%);
  animation: pulse 1s ease-out;
}

.department-card i {
  font-size: 2.5rem;
  color: var(--primary);
  margin-bottom: 15px;
  display: block;
  animation: float 3s ease-in-out infinite;
}

.department-card h3 {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 1.2rem;
}

.department-card p {
  color: var(--gray);
  font-size: 0.9rem;
}

/* Location Section */
.location-section {
  background: var(--gray-light);
  border-radius: var(--border-radius);
  padding: 25px;
  margin-bottom: 25px;
  text-align: center;
  animation: slideInUp 0.6s ease-out;
}

.location-section i {
  font-size: 2.5rem;
  color: var(--primary);
  margin-bottom: 15px;
  display: block;
  animation: bounce 1s ease-out;
}

.location-section p {
  margin-bottom: 20px;
  font-size: 1.1rem;
}

.location-details {
  background: white;
  padding: 20px;
  border-radius: var(--border-radius);
  margin-top: 20px;
  text-align: left;
  font-size: 1rem;
  animation: slideInUp 0.6s ease-out;
}

.location-details strong {
  color: var(--primary);
}

.address-details {
  margin-top: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 12px;
}

.address-line {
  margin-bottom: 8px;
  animation: fadeIn 0.6s ease-out;
}

/* Media Capture */
.media-options {
  display: flex;
  gap: 15px;
  margin-bottom: 25px;
}

.media-option {
  flex: 1;
  text-align: center;
  padding: 20px;
  background: var(--gray-light);
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
  border: 3px solid transparent;
  animation: slideInUp 0.6s ease-out;
}

.media-option.active {
  background: white;
  border-color: var(--primary);
  box-shadow: var(--shadow);
  animation: pulse 0.5s ease-out;
}

.media-option i {
  font-size: 1.8rem;
  margin-bottom: 10px;
  display: block;
  color: var(--primary);
}

.media-option p {
  font-weight: 600;
  color: var(--dark);
  font-size: 1.1rem;
}

.camera-container {
  position: relative;
  margin-bottom: 25px;
  border-radius: var(--border-radius);
  overflow: hidden;
  background: #000;
  animation: slideInUp 0.6s ease-out;
}

#camera {
  width: 100%;
  display: block;
}

.media-preview {
  width: 100%;
  border-radius: var(--border-radius);
  margin-bottom: 25px;
  display: none;
  animation: slideInUp 0.6s ease-out;
}

.media-controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  animation: slideInUp 0.6s ease-out;
}

.voice-control {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--gray-light);
  padding: 12px 20px;
  border-radius: var(--border-radius);
}

.voice-toggle {
  background: var(--gray);
  width: 50px;
  height: 25px;
  border-radius: 15px;
  position: relative;
  cursor: pointer;
  transition: var(--transition);
}

.voice-toggle.active {
  background: var(--success);
}

.voice-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 21px;
  height: 21px;
  background: white;
  border-radius: 50%;
  transition: var(--transition);
}

.voice-toggle.active::after {
  left: 27px;
}

/* Buttons */
.btn {
  padding: 15px 30px;
  border: none;
  border-radius: var(--border-radius);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
  width: 300px;
  height: 300px;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
}

.btn-secondary {
  background: var(--gray-light);
  color: var(--dark);
}

.btn-secondary:hover:not(:disabled) {
  background: #d1d5db;
  transform: translateY(-2px);
}

.btn-success {
  background: var(--success);
  color: white;
  box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
}

.btn-success:hover:not(:disabled) {
  background: #3ab0d9;
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(76, 201, 240, 0.4);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover:not(:disabled) {
  background: #e1156f;
  transform: translateY(-2px);
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-warning:hover:not(:disabled) {
  background: #e0861b;
  transform: translateY(-2px);
}

.btn-info {
  background: var(--secondary);
  color: white;
}

.btn-info:hover:not(:disabled) {
  background: #61099c;
  transform: translateY(-3px);
}

.btn-block {
  width: 100%;
}

.btn-small {
  padding: 10px 20px;
  font-size: 1rem;
}

/* Navigation */
.navigation {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  animation: slideInUp 0.6s ease-out;
}

/* Status Message */
.status-message {
  padding: 20px;
  border-radius: var(--border-radius);
  margin-bottom: 25px;
  text-align: center;
  font-weight: 600;
  display: none;
  animation: slideInUp 0.6s ease-out;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  animation: shake 0.5s ease-in-out;
}

/* Review Step */
.review-item {
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--gray-light);
  animation: slideInUp 0.6s ease-out;
}

.review-item:last-child {
  border-bottom: none;
}

.review-label {
  font-weight: 600;
  color: var(--gray);
  margin-bottom: 8px;
  font-size: 1rem;
}

.review-value {
  color: var(--dark);
  word-break: break-word;
  font-size: 1.1rem;
}

.review-media {
  max-width: 100%;
  border-radius: 12px;
  margin-top: 15px;
  animation: fadeIn 0.6s ease-out;
}

/* Success Animation */
@keyframes success {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

.success-animation {
  animation: success 0.6s ease-out;
}

/* Hidden elements */
.hidden {
  display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
  .hero h1 {
    font-size: 2rem;
  }
  
  .step-label {
    display: none;
  }
  
  .media-options {
    flex-direction: column;
  }
  
  .navigation {
    flex-direction: column;
    gap: 15px;
  }
  
  .navigation .btn {
    width: 100%;
  }
  
  .department-selection {
    grid-template-columns: 1fr;
  }
  
  .form-step {
    padding: 25px;
  }
}

/* Loading Spinner */
.spinner {
  display: inline-block;
  width: 25px;
  height: 25px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Confetti Animation */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  background: var(--primary);
  top: 0;
  opacity: 0;
  z-index: 1000;
}

@keyframes confettiFall {
  0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <section class="hero">
    <h1><i class="fas fa-bullhorn"></i> Smart Complaint Hub</h1>
    <p>Report civic issues with advanced features</p>
  </section>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress" id="progress"></div>
      <div class="step active" id="step1">
        <span>1</span>
        <div class="step-label">Department</div>
      </div>
      <div class="step" id="step2">
        <span>2</span>
        <div class="step-label">Details</div>
      </div>
      <div class="step" id="step3">
        <span>3</span>
        <div class="step-label">Location</div>
      </div>
      <div class="step" id="step4">
        <span>4</span>
        <div class="step-label">Media</div>
      </div>
      <div class="step" id="step5">
        <span>5</span>
        <div class="step-label">Review</div>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <div class="form-container">
    <!-- Step 1: Department -->
    <div class="form-step active" id="step1-form">
      <div class="step-header">
        <h2>Department Selection</h2>
        <p>Choose the relevant department for your complaint</p>
      </div>
      
      <div class="department-selection" id="departmentSelection">
        <div class="department-card" data-dept="Roads & Infrastructure">
          <i class="fas fa-road"></i>
          <h3>Roads & Infrastructure</h3>
          <p>Potholes, road damage, traffic signals</p>
        </div>
        <div class="department-card" data-dept="Sanitation">
          <i class="fas fa-trash"></i>
          <h3>Sanitation</h3>
          <p>Garbage collection, waste management</p>
        </div>
        <div class="department-card" data-dept="Electricity">
          <i class="fas fa-bolt"></i>
          <h3>Electricity</h3>
          <p>Power outages, street lights, electrical issues</p>
        </div>
        <div class="department-card" data-dept="Water Supply">
          <i class="fas fa-tint"></i>
          <h3>Water Supply</h3>
          <p>Water leaks, supply issues, quality problems</p>
        </div>
        <div class="department-card" data-dept="Others">
          <i class="fas fa-ellipsis-h"></i>
          <h3>Other Issues</h3>
          <p>Any other civic issues</p>
        </div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" disabled><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn btn-primary" id="nextToStep2">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 2: Personal & Complaint Details -->
    <div class="form-step" id="step2-form">
      <div class="step-header">
        <h2>Complaint Details</h2>
        <p>Provide your information and describe the issue</p>
      </div>
      
      <div class="form-group">
        <label for="name"><i class="fas fa-user"></i> Your Name</label>
        <input type="text" id="name" class="form-control" placeholder="Enter your full name" required>
        <div class="error-message" id="nameError">Please enter your name</div>
      </div>
      
      <!-- NEW EMAIL FIELD ADDED HERE -->
      <div class="form-group">
        <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="email" id="email" class="form-control" placeholder="Enter your email address" required>
        <div class="error-message" id="emailError">Please enter a valid email address</div>
      </div>
      
      <div class="form-group">
        <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
        <input type="tel" id="phone" class="form-control" placeholder="Enter your 10-digit phone number" pattern="[0-9]{10}" required>
        <div class="error-message" id="phoneError">Please enter a valid 10-digit phone number</div>
      </div>
      
      <div class="form-group">
        <label for="details"><i class="fas fa-comment-alt"></i> Complaint Details</label>
        <textarea id="details" class="form-control" rows="5" placeholder="Describe the issue in detail..." required></textarea>
        <div class="error-message" id="detailsError">Please provide details about the issue</div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" id="prevToStep1"><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn btn-primary" id="nextToStep3">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 3: Location -->
    <div class="form-step" id="step3-form">
      <div class="step-header">
        <h2>Location Details</h2>
        <p>We'll automatically detect your location</p>
      </div>
      
      <div class="location-section">
        <i class="fas fa-map-marker-alt"></i>
        <p>We're detecting your current location to tag your complaint</p>
        <button class="btn btn-primary" id="detectLocation">
          <i class="fas fa-location-arrow"></i> Detect My Location
        </button>
        
        <div class="location-details hidden" id="locationDetails">
          <p><strong>Detected Location:</strong></p>
          <div class="address-details" id="addressDetails">
            <div class="address-line" id="streetAddress">Fetching location...</div>
            <div class="address-line" id="cityState"></div>
            <div class="address-line" id="country"></div>
          </div>
          <button class="btn btn-small btn-secondary" id="refreshLocation" style="margin-top: 10px;">
            <i class="fas fa-sync-alt"></i> Refresh Location
          </button>
        </div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" id="prevToStep2"><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn btn-primary" id="nextToStep4">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 4: Media Capture -->
    <div class="form-step" id="step4-form">
      <div class="step-header">
        <h2>Add Media Evidence</h2>
        <p>Capture a photo or video of the issue</p>
      </div>
      
      <div class="media-options">
        <div class="media-option active" data-type="photo">
          <i class="fas fa-camera"></i>
          <p>Take Photo</p>
        </div>
        <div class="media-option" data-type="video">
          <i class="fas fa-video"></i>
          <p>Record Video</p>
        </div>
      </div>
      
      <div class="camera-container hidden" id="cameraContainer">
        <video id="camera" autoplay playsinline></video>
      </div>
      
      <img id="photoPreview" class="media-preview" alt="Photo preview">
      <video id="videoPreview" class="media-preview" controls></video>
      
      <div class="media-controls">
        <button class="btn btn-primary" id="openCameraBtn">
          <i class="fas fa-camera"></i> Open Camera
        </button>
        <button class="btn btn-success hidden" id="capturePhotoBtn">
          <i class="fas fa-camera"></i> Capture Photo
        </button>
        <button class="btn btn-success hidden" id="startVideoBtn">
          <i class="fas fa-video"></i> Start Recording
        </button>
        <button class="btn btn-danger hidden" id="stopVideoBtn">
          <i class="fas fa-stop"></i> Stop Recording
        </button>
        <button class="btn btn-warning hidden" id="deleteMediaBtn">
          <i class="fas fa-trash"></i> Delete Media
        </button>
        <button class="btn btn-info hidden" id="stopCameraBtn">
          <i class="fas fa-times"></i> Stop Camera
        </button>
        <div class="voice-control hidden" id="voiceControl">
          <i class="fas fa-microphone"></i>
          <span>Voice</span>
          <div class="voice-toggle" id="voiceToggle"></div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" id="prevToStep3"><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn btn-primary" id="nextToStep5">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 5: Review & Submit -->
    <div class="form-step" id="step5-form">
      <div class="step-header">
        <h2>Review Your Complaint</h2>
        <p>Please verify all information before submitting</p>
      </div>
      
      <div class="review-item">
        <div class="review-label">Department</div>
        <div class="review-value" id="reviewDept"></div>
      </div>
      
      <div class="review-item">
        <div class="review-label">Your Details</div>
        <div class="review-value" id="reviewPersonal"></div>
      </div>
      
      <div class="review-item">
        <div class="review-label">Complaint Details</div>
        <div class="review-value" id="reviewDetails"></div>
      </div>
      
      <div class="review-item">
        <div class="review-label">Location</div>
        <div class="review-value" id="reviewLocation"></div>
      </div>
      
      <div class="review-item">
        <div class="review-label">Media Evidence</div>
        <div class="review-value" id="reviewMedia"></div>
        <img id="reviewPhoto" class="review-media hidden" alt="Photo preview">
        <video id="reviewVideo" class="review-media hidden" controls></video>
      </div>
      
      <div class="status-message" id="statusMsg"></div>
      
      <div class="navigation">
        <button class="btn btn-secondary" id="prevToStep4"><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn btn-success" id="submitComplaint">
          <i class="fas fa-paper-plane"></i> Submit Complaint
        </button>
      </div>
    </div>
  </div>

  <!-- View Status Link -->
  <div style="text-align: center; margin-top: 20px;">
    <a href="status.html" class="btn btn-info" style="text-decoration: none;">
      <i class="fas fa-clipboard-list"></i> View Complaint Status
    </a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// DOM Elements
const steps = document.querySelectorAll('.step');
const stepForms = document.querySelectorAll('.form-step');
const progress = document.getElementById('progress');
const departmentSelection = document.getElementById('departmentSelection');
const departmentCards = document.querySelectorAll('.department-card');

// Form elements
const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email'); // NEW: Email input
const phoneInput = document.getElementById('phone');
const detailsInput = document.getElementById('details');

// Error messages
const nameError = document.getElementById('nameError');
const emailError = document.getElementById('emailError'); // NEW: Email error
const phoneError = document.getElementById('phoneError');
const detailsError = document.getElementById('detailsError');

// Location elements
const detectLocationBtn = document.getElementById('detectLocation');
const locationDetails = document.getElementById('locationDetails');
const streetAddress = document.getElementById('streetAddress');
const cityState = document.getElementById('cityState');
const country = document.getElementById('country');
const refreshLocationBtn = document.getElementById('refreshLocation');

// Media elements
const camera = document.getElementById('camera');
const cameraContainer = document.getElementById('cameraContainer');
const photoPreview = document.getElementById('photoPreview');
const videoPreview = document.getElementById('videoPreview');
const openCameraBtn = document.getElementById('openCameraBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
const startVideoBtn = document.getElementById('startVideoBtn');
const stopVideoBtn = document.getElementById('stopVideoBtn');
const deleteMediaBtn = document.getElementById('deleteMediaBtn');
const stopCameraBtn = document.getElementById('stopCameraBtn');
const mediaOptions = document.querySelectorAll('.media-option');
const voiceControl = document.getElementById('voiceControl');
const voiceToggle = document.getElementById('voiceToggle');

// Review elements
const reviewDept = document.getElementById('reviewDept');
const reviewPersonal = document.getElementById('reviewPersonal');
const reviewDetails = document.getElementById('reviewDetails');
const reviewLocation = document.getElementById('reviewLocation');
const reviewMedia = document.getElementById('reviewMedia');
const reviewPhoto = document.getElementById('reviewPhoto');
const reviewVideo = document.getElementById('reviewVideo');

// Status message
const statusMsg = document.getElementById('statusMsg');

// Navigation buttons
const nextToStep2 = document.getElementById('nextToStep2');
const prevToStep1 = document.getElementById('prevToStep1');
const nextToStep3 = document.getElementById('nextToStep3');
const prevToStep2 = document.getElementById('prevToStep2');
const nextToStep4 = document.getElementById('nextToStep4');
const prevToStep3 = document.getElementById('prevToStep3');
const nextToStep5 = document.getElementById('nextToStep5');
const prevToStep4 = document.getElementById('prevToStep4');
const submitComplaint = document.getElementById('submitComplaint');

// Global variables
let currentStep = 1;
let department = "Not Selected";
let userLocation = {
  street: "",
  city: "",
  state: "",
  country: "",
  fullAddress: "Fetching location..."
};
let stream = null;
let mediaRecorder = null;
let recordedChunks = [];
let capturedPhotoFile = null;
let capturedVideoFile = null;
let selectedMediaType = 'photo';
let audioEnabled = false;

// Supabase config
const SUPABASE_URL = "https://wufxlfsavttdijwyxwsv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1ZnhsZnNhdnR0ZGlqd3l4d3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTM1MzcsImV4cCI6MjA3NTc2OTUzN30.NTxr-qXhKJA0CAZ_mX3Q7bE9NbaANtH7AfJ9mI5FvAg";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET_NAME = "complaint-media";

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  setupEventListeners();
  loadSavedData();
  addPageLoadAnimations();
});

// Add page load animations
function addPageLoadAnimations() {
  // Animate elements sequentially
  const animatedElements = document.querySelectorAll('.form-group, .department-card, .media-option');
  animatedElements.forEach((el, index) => {
    el.style.animationDelay = `${index * 0.1}s`;
  });
}

// Load saved form data
function loadSavedData() {
  const savedData = localStorage.getItem('complaintFormData');
  if (savedData) {
    const data = JSON.parse(savedData);
    nameInput.value = data.name || '';
    emailInput.value = data.email || ''; // NEW: Load saved email
    phoneInput.value = data.phone || '';
    detailsInput.value = data.details || '';
    
    if (data.department) {
      selectDepartment(data.department);
    }
    
    if (data.location && data.location.fullAddress) {
      userLocation = data.location;
      updateLocationDisplay();
      locationDetails.classList.remove('hidden');
    }
  }
}

// Save form data
function saveFormData() {
  const formData = {
    name: nameInput.value,
    email: emailInput.value, // NEW: Save email
    phone: phoneInput.value,
    details: detailsInput.value,
    department: department,
    location: userLocation
  };
  localStorage.setItem('complaintFormData', JSON.stringify(formData));
}


// Set up event listeners
function setupEventListeners() {
  // Department selection
  departmentCards.forEach(card => {
    card.addEventListener('click', function() {
      selectDepartment(this.getAttribute('data-dept'));
    });
  });
  
  // Navigation
  nextToStep2.addEventListener('click', () => validateStep1());
  prevToStep1.addEventListener('click', () => changeStep(1));
  nextToStep3.addEventListener('click', () => validateStep2());
  prevToStep2.addEventListener('click', () => changeStep(2));
  nextToStep4.addEventListener('click', () => validateStep3());
  prevToStep3.addEventListener('click', () => changeStep(3));
  nextToStep5.addEventListener('click', () => validateStep4());
  prevToStep4.addEventListener('click', () => changeStep(4));
  submitComplaint.addEventListener('click', submitComplaintForm);
  
  // Form validation
  nameInput.addEventListener('input', validateName);
  emailInput.addEventListener('input', validateEmail); // NEW: Email validation
  phoneInput.addEventListener('input', validatePhone);
  detailsInput.addEventListener('input', validateDetails);
  
  // Auto-save form data
  nameInput.addEventListener('blur', saveFormData);
  emailInput.addEventListener('blur', saveFormData); // NEW: Save email on blur
  phoneInput.addEventListener('blur', saveFormData);
  detailsInput.addEventListener('blur', saveFormData);
  
  // Location
  detectLocationBtn.addEventListener('click', updateLocation);
  refreshLocationBtn.addEventListener('click', updateLocation);
  
  // Media
  openCameraBtn.addEventListener('click', openCamera);
  capturePhotoBtn.addEventListener('click', capturePhoto);
  startVideoBtn.addEventListener('click', startVideoRecording);
  stopVideoBtn.addEventListener('click', stopVideoRecording);
  deleteMediaBtn.addEventListener('click', deleteMedia);
  stopCameraBtn.addEventListener('click', stopCamera);
  
  // Voice toggle
  voiceToggle.addEventListener('click', function() {
    audioEnabled = !audioEnabled;
    this.classList.toggle('active');
    
    if (audioEnabled) {
      this.parentElement.querySelector('span').textContent = 'Voice On';
    } else {
      this.parentElement.querySelector('span').textContent = 'Voice Off';
    }
  });
  
  // Media type selection
  mediaOptions.forEach(option => {
    option.addEventListener('click', function() {
      mediaOptions.forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      selectedMediaType = this.getAttribute('data-type');
      
      // Show/hide voice control
      if (selectedMediaType === 'video') {
        voiceControl.classList.remove('hidden');
      } else {
        voiceControl.classList.add('hidden');
      }
      
      // Reset media when switching type
      deleteMedia();
    });
  });
}

// NEW: Email validation function
function validateEmail() {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(emailInput.value)) {
    emailError.style.display = 'block';
    emailInput.classList.add('error');
    showErrorAnimation(emailInput);
    return false;
  } else {
    emailError.style.display = 'none';
    emailInput.classList.remove('error');
    return true;
  }
}

// Select department
function selectDepartment(dept) {
  department = dept;
  
  // Update UI with animation
  departmentCards.forEach(card => {
    if (card.getAttribute('data-dept') === dept) {
      card.classList.add('selected');
      card.style.animation = 'pulse 0.6s ease-out';
    } else {
      card.classList.remove('selected');
    }
  });
  
  // Save to localStorage
  saveFormData();
}

// Change step
function changeStep(step) {
  // Hide all steps
  stepForms.forEach(form => form.classList.remove('active'));
  steps.forEach(step => step.classList.remove('active'));
  
  // Show current step
  document.getElementById(`step${step}-form`).classList.add('active');
  document.getElementById(`step${step}`).classList.add('active');
  
  // Update progress bar
  const progressPercent = ((step - 1) / (steps.length - 1)) * 100;
  progress.style.width = `${progressPercent}%`;
  
  // Update step indicators
  for (let i = 1; i < step; i++) {
    document.getElementById(`step${i}`).classList.add('completed');
  }
  
  for (let i = step + 1; i <= steps.length; i++) {
    document.getElementById(`step${i}`).classList.remove('completed');
  }
  
  currentStep = step;
  
  // Update review section if we're on the last step
  if (step === 5) {
    updateReviewSection();
  }
}

// Step validation functions
function validateStep1() {
  if (department === "Not Selected") {
    showErrorAnimation(departmentSelection);
    alert("Please select a department before proceeding");
    return;
  }
  changeStep(2);
}

function validateStep2() {
  if (validateName() && validateEmail() && validatePhone() && validateDetails()) { // UPDATED: Include email validation
    changeStep(3);
  }
}

function validateStep3() {
  if (userLocation.fullAddress && userLocation.fullAddress !== "Fetching location...") {
    changeStep(4);
  } else {
    showErrorAnimation(detectLocationBtn);
    alert("Please detect your location before proceeding");
  }
}

function validateStep4() {
  if (capturedPhotoFile || capturedVideoFile) {
    changeStep(5);
  } else {
    showErrorAnimation(openCameraBtn);
    alert("Please capture a photo or video before proceeding");
  }
}

// Field validation functions
function validateName() {
  if (nameInput.value.trim() === '') {
    nameError.style.display = 'block';
    nameInput.classList.add('error');
    showErrorAnimation(nameInput);
    return false;
  } else {
    nameError.style.display = 'none';
    nameInput.classList.remove('error');
    return true;
  }
}

function validatePhone() {
  const phoneRegex = /^[0-9]{10}$/;
  if (!phoneRegex.test(phoneInput.value)) {
    phoneError.style.display = 'block';
    phoneInput.classList.add('error');
    showErrorAnimation(phoneInput);
    return false;
  } else {
    phoneError.style.display = 'none';
    phoneInput.classList.remove('error');
    return true;
  }
}

function validateDetails() {
  if (detailsInput.value.trim() === '') {
    detailsError.style.display = 'block';
    detailsInput.classList.add('error');
    showErrorAnimation(detailsInput);
    return false;
  } else {
    detailsError.style.display = 'none';
    detailsInput.classList.remove('error');
    return true;
  }
}

// Show error animation
function showErrorAnimation(element) {
  element.style.animation = 'shake 0.5s ease-in-out';
  setTimeout(() => {
    element.style.animation = '';
  }, 500);
}

// Location functions
async function updateLocation() {
  detectLocationBtn.innerHTML = '<span class="spinner"></span> Detecting Location...';
  detectLocationBtn.disabled = true;
  
  try {
    const position = await getCurrentPosition();
    const lat = position.coords.latitude.toFixed(5);
    const lon = position.coords.longitude.toFixed(5);
    await fetchAddress(lat, lon);
    
    locationDetails.classList.remove('hidden');
    locationDetails.style.animation = 'slideInUp 0.6s ease-out';
    
    // Save to localStorage
    saveFormData();
  } catch (error) {
    userLocation = {
      street: "Location not available",
      city: "",
      state: "",
      country: "",
      fullAddress: "Location not available"
    };
    updateLocationDisplay();
    locationDetails.classList.remove('hidden');
    showErrorAnimation(detectLocationBtn);
  } finally {
    detectLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Detect My Location';
    detectLocationBtn.disabled = false;
  }
}

function updateLocationDisplay() {
  streetAddress.textContent = userLocation.street || "Address not available";
  cityState.textContent = userLocation.city && userLocation.state ? 
    `${userLocation.city}, ${userLocation.state}` : "";
  country.textContent = userLocation.country || "";
}

function getCurrentPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation is not supported'));
      return;
    }
    
    navigator.geolocation.getCurrentPosition(resolve, reject, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    });
  });
}

async function fetchAddress(lat, lon) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
    const data = await response.json();
    
    if (data && data.address) {
      const addr = data.address;
      
      // Extract address components
      const houseNumber = addr.house_number || '';
      const road = addr.road || '';
      const suburb = addr.suburb || '';
      const city = addr.city || addr.town || addr.village || '';
      const state = addr.state || '';
      const postcode = addr.postcode || '';
      const country = addr.country || '';
      
      // Build formatted address
      const streetAddress = `${houseNumber} ${road}`.trim();
      const cityState = `${city}${state ? ', ' + state : ''}${postcode ? ' ' + postcode : ''}`;
      
      userLocation = {
        street: streetAddress || data.display_name.split(',')[0],
        city: city,
        state: state,
        country: country,
        fullAddress: data.display_name
      };
    } else {
      userLocation = {
        street: "Address details not available",
        city: "",
        state: "",
        country: "",
        fullAddress: `${lat}, ${lon}`
      };
    }
    
    updateLocationDisplay();
  } catch (error) {
    userLocation = {
      street: "Error fetching address",
      city: "",
      state: "",
      country: "",
      fullAddress: `${lat}, ${lon}`
    };
    updateLocationDisplay();
  }
}

// Media functions
async function openCamera() {
  try {
    const constraints = {
      video: { facingMode: "environment" },
      audio: selectedMediaType === 'video' && audioEnabled
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    
    camera.srcObject = stream;
    cameraContainer.classList.remove('hidden');
    cameraContainer.style.animation = 'slideInUp 0.6s ease-out';
    openCameraBtn.classList.add('hidden');
    stopCameraBtn.classList.remove('hidden');
    
    if (selectedMediaType === 'photo') {
      capturePhotoBtn.classList.remove('hidden');
    } else {
      startVideoBtn.classList.remove('hidden');
    }
  } catch (error) {
    alert("Camera access denied: " + error.message);
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  
  cameraContainer.classList.add('hidden');
  capturePhotoBtn.classList.add('hidden');
  startVideoBtn.classList.add('hidden');
  stopVideoBtn.classList.add('hidden');
  stopCameraBtn.classList.add('hidden');
  openCameraBtn.classList.remove('hidden');
}

async function capturePhoto() {
  if (!stream) {
    alert("Camera not started!");
    return;
  }
  
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  canvas.width = camera.videoWidth;
  canvas.height = camera.videoHeight;
  
  // Draw the current video frame to the canvas
  context.drawImage(camera, 0, 0, canvas.width, canvas.height);
  
  // Add timestamp and location overlay
  const now = new Date();
  const dateTime = now.toLocaleString();
  
  context.fillStyle = "rgba(0, 0, 0, 0.7)";
  context.fillRect(10, canvas.height - 100, canvas.width - 20, 90);
  
  context.fillStyle = "white";
  context.font = "14px Arial";
  context.fillText(`Dept: ${department}`, 20, canvas.height - 75);
  context.fillText(`Location: ${userLocation.fullAddress}`, 20, canvas.height - 55);
  context.fillText(`Time: ${dateTime}`, 20, canvas.height - 35);
  
  // Convert to blob and create file
  canvas.toBlob((blob) => {
    capturedPhotoFile = new File([blob], `photo_${Date.now()}.png`, { type: "image/png" });
    
    // Display preview
    photoPreview.src = URL.createObjectURL(capturedPhotoFile);
    photoPreview.classList.remove('hidden');
    photoPreview.style.animation = 'slideInUp 0.6s ease-out';
    deleteMediaBtn.classList.remove('hidden');
    
    // Reset video capture
    capturedVideoFile = null;
    videoPreview.classList.add('hidden');
    
    stopCamera();
  }, 'image/png');
}

function startVideoRecording() {
  if (!stream) {
    alert("Camera not started!");
    return;
  }
  
  recordedChunks = [];
  
  // Update audio constraints based on voice toggle
  const options = {
    mimeType: 'video/webm; codecs=vp8,opus',
    audioBitsPerSecond: audioEnabled ? 128000 : 0
  };
  
  mediaRecorder = new MediaRecorder(stream, options);
  
  mediaRecorder.ondataavailable = (event) => {
    if (event.data.size > 0) {
      recordedChunks.push(event.data);
    }
  };
  
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    capturedVideoFile = new File([blob], `video_${Date.now()}.webm`, { type: 'video/webm' });
    
    // Display preview
    videoPreview.src = URL.createObjectURL(capturedVideoFile);
    videoPreview.classList.remove('hidden');
    videoPreview.style.animation = 'slideInUp 0.6s ease-out';
    deleteMediaBtn.classList.remove('hidden');
    
    // Reset photo capture
    capturedPhotoFile = null;
    photoPreview.classList.add('hidden');
    
    stopCamera();
  };
  
  mediaRecorder.start();
  startVideoBtn.classList.add('hidden');
  stopVideoBtn.classList.remove('hidden');
}

function stopVideoRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
  }
  
  startVideoBtn.classList.remove('hidden');
  stopVideoBtn.classList.add('hidden');
}

function deleteMedia() {
  capturedPhotoFile = null;
  capturedVideoFile = null;
  
  photoPreview.src = '';
  videoPreview.src = '';
  
  photoPreview.classList.add('hidden');
  videoPreview.classList.add('hidden');
  deleteMediaBtn.classList.add('hidden');
}

// Review section
function updateReviewSection() {
  reviewDept.textContent = department;
  reviewPersonal.textContent = `${nameInput.value} | ${emailInput.value} | ${phoneInput.value}`; // UPDATED: Include email
  reviewDetails.textContent = detailsInput.value;
  reviewLocation.textContent = userLocation.fullAddress;
  
  if (capturedPhotoFile) {
    reviewMedia.textContent = "Photo evidence attached";
    reviewPhoto.src = photoPreview.src;
    reviewPhoto.classList.remove('hidden');
    reviewPhoto.style.animation = 'slideInUp 0.6s ease-out';
    reviewVideo.classList.add('hidden');
  } else if (capturedVideoFile) {
    reviewMedia.textContent = "Video evidence attached";
    reviewVideo.src = videoPreview.src;
    reviewVideo.classList.remove('hidden');
    reviewVideo.style.animation = 'slideInUp 0.6s ease-out';
    reviewPhoto.classList.add('hidden');
  } else {
    reviewMedia.textContent = "No media attached";
    reviewPhoto.classList.add('hidden');
    reviewVideo.classList.add('hidden');
  }
}

// Upload file to Supabase Storage
async function uploadFile(file) {
  try {
    const fileName = `${Date.now()}_${file.name}`;
    const { data, error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, file, { 
      upsert: true,
      cacheControl: '3600'
    });
    
    if (error) {
      console.error("Upload error:", error);
      throw new Error("File upload failed: " + error.message);
    }
    
    const { data: urlData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileName);
    return urlData.publicUrl;
  } catch (error) {
    console.error("Upload function error:", error);
    throw error;
  }
}

// Create confetti effect
function createConfetti() {
  const colors = ['#4361ee', '#7209b7', '#4cc9f0', '#f72585', '#f8961e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
    confetti.style.animationDelay = Math.random() * 2 + 's';
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 5000);
  }
}

// Submit complaint
async function submitComplaintForm() {
  // Validate form - ADD EMAIL VALIDATION
  if (!validateName() || !validateEmail() || !validatePhone() || !validateDetails()) {
    alert("Please fix the errors in the form before submitting");
    return;
  }

  if (!capturedPhotoFile && !capturedVideoFile) {
    alert("Please capture a photo or video before submitting");
    return;
  }

  submitComplaint.innerHTML = '<span class="spinner"></span> Submitting...';
  submitComplaint.disabled = true;

  try {
    // Upload media files
    let photoURL = null;
    let videoURL = null;

    if (capturedPhotoFile) {
      photoURL = await uploadFile(capturedPhotoFile);
    }

    if (capturedVideoFile) {
      videoURL = await uploadFile(capturedVideoFile);
    }

    // Get form values - ADD EMAIL
    const name = nameInput.value;
    const email = emailInput.value; // NEW: Get email value
    const phone = phoneInput.value;
    const details = detailsInput.value;

    // Store phone in localStorage
    localStorage.setItem('userPhone', phone);

    // Get current location coordinates (if available)
    let latitude = null;
    let longitude = null;
    
    // Try to get coordinates from the detected location
    try {
      const position = await getCurrentPosition();
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;
    } catch (error) {
      console.log("Could not get coordinates:", error);
      // Continue without coordinates
    }

    // UPDATE: Submit to Supabase with email field
    const { data, error } = await supabase.from('complaints').insert([
      { 
        name: name, 
        email: email, // NEW: Include email
        phone: phone, 
        details: details, 
        department: department, 
        location: userLocation.fullAddress,
        latitude: latitude,
        longitude: longitude,
        photo: photoURL, 
        video: videoURL,
        created_at: new Date().toISOString()
      }
    ]);

    if (error) {
      throw new Error("Database submission failed: " + error.message);
    }

    // Show success message with animation
    statusMsg.textContent = "✅ Complaint submitted successfully! Redirecting...";
    statusMsg.classList.add('status-success');
    statusMsg.classList.remove('hidden');
    statusMsg.style.animation = 'success 0.6s ease-out';

    // Create confetti effect
    createConfetti();

    // Clear saved form data
    localStorage.removeItem('complaintFormData');

    // Redirect after 2 seconds
    setTimeout(() => {
      window.location.href = "status.html";
    }, 2000);

  } catch (error) {
    console.error("Submission error:", error);
    statusMsg.textContent = "❌ " + error.message;
    statusMsg.classList.add('status-error');
    statusMsg.classList.remove('hidden');
    statusMsg.style.animation = 'shake 0.5s ease-in-out';

    submitComplaint.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Complaint';
    submitComplaint.disabled = false;
  }
}

// Auto-skip Step 1 if department is already stored
document.addEventListener('DOMContentLoaded', function () {
  const storedDept = localStorage.getItem('department');
  console.log("Auto-load department from storage:", storedDept);

  if (storedDept && storedDept !== "Not Selected") {
    // Set department globally
    department = storedDept;

    // Highlight the department card if exists
    const deptCard = document.querySelector(`.department-card[data-dept="${storedDept}"]`);
    if (deptCard) {
      deptCard.classList.add('selected');
    }

    // Save form data with this dept
    saveFormData();

    // Skip to Step 2 automatically
    changeStep(2);
  }
});
</script>
</body>
</html>